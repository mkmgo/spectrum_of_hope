<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Loading...</title>
    <link rel="stylesheet" href="styles.css">
    <script>
        // --- Theme Management ---
        document.addEventListener('DOMContentLoaded', () => {
            const currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            document.body.setAttribute('data-theme', currentTheme);
        });

        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // --- Content & Language Loading ---
        let contentData = {};
        let currentLang = localStorage.getItem('lang') || 'en';

        async function loadContent(pageId) {
            try {
                // CRITICAL: Robust path to fetch the JSON file
                const response = await fetch('./content.json');
                contentData = await response.json();
            } catch (error) {
                console.error("Fatal Error: Could not fetch or parse content.json", error);
                document.getElementById('page-title').textContent = "Error Loading Content";
                return;
            }
            
            // Get the data block for the current language and page
            const langData = contentData[currentLang];
            if (!langData) {
                 console.error(`Language data for ${currentLang} not found.`);
                 return;
            }
            
            const pageData = langData[pageId];
            if (!pageData) {
                console.error(`Page data for ${pageId} not found in language ${currentLang}.`);
                return;
            }

            // 1. Set Page Title
            const pageTitleElement = document.getElementById('page-title');
            if (pageTitleElement) pageTitleElement.textContent = pageData.title;

            // 2. Inject Sequential Navigation Links
            const navTop = document.getElementById('chapter-nav-top');
            if (navTop) {
                let navHTML = '';
                
                // Previous Link
                if (pageData.prev_story_link) {
                    navHTML += `<a href="${pageData.prev_story_link}" class="nav-prev">‚Üê Previous</a> | `;
                } else {
                    navHTML += `<span class="nav-placeholder"></span> | `;
                }
                
                // Home Link
                if(langData.index && langData.index.page_url) {
                    navHTML += `<a href="${langData.index.page_url}" class="nav-home">Home</a> | `;
                } else {
                    navHTML += `<span class="nav-placeholder"></span> | `;
                }


                // Next Link
                if (pageData.next_story_link) {
                    navHTML += `<a href="${pageData.next_story_link}" class="nav-next">Next ‚Üí</a>`;
                } else {
                    navHTML += `<span class="nav-placeholder"></span>`;
                }

                navTop.innerHTML = navHTML;
            }

            // 3. Inject Image and Caption
            const imgContainer = document.getElementById('image-container');
            const imgData = pageData.image;

            if (imgContainer && imgData) {
                // Conditional soft background logic
                if (imgData.use_soft_bg) { 
                    imgContainer.classList.add('soft-background-image');
                } else {
                    imgContainer.classList.remove('soft-background-image');
                }
                
                // Flexible replacement for JPG or PNG to generate WebP URL
                const webpUrl = imgData.url.replace(/\.(jpe?g|png)$/i, '.webp'); 

                const imgHTML = `
                    <picture>
                        <source srcset="${webpUrl}" type="image/webp">
                        <img 
                            src="${imgData.url}" 
                            alt="${imgData.caption}" 
                            style="width: 100%;" 
                        >
                    </picture>
                    <figcaption>${imgData.caption}</figcaption>
                `;
                imgContainer.innerHTML = imgHTML;
                
                // Set the image's width relative to the text using flex-basis (for desktop)
                imgContainer.style.flexBasis = imgData.size_percentage + '%'; 
            } else if (imgContainer) {
                imgContainer.style.display = 'none';
            }

            // 4. Inject Content Blocks
            const storyText = document.getElementById('story-text-content');
            if (storyText) {
                storyText.innerHTML = `<h1>${pageData.title}</h1>`;

                pageData.content.forEach(block => {
                    let htmlBlock = '';
                    if (block.type === 'headline') {
                        htmlBlock = `<h2>${block.text}</h2>`;
                    } else if (block.type === 'text') {
                        htmlBlock = `<p>${block.text}</p>`;
                    } else if (block.type === 'link') {
                        const actionClass = block.action === 'download' ? 'download-link' : 'paypal-button';
                        htmlBlock = `<a href="${block.url}" class="${actionClass}" target="_blank">${block.text}</a>`;
                    }
                    storyText.innerHTML += htmlBlock;
                });
            }
            
            // 5. Set active language button
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === currentLang);
            });
        }

        function switchLanguage(newLang) {
            if (contentData[newLang]) {
                localStorage.setItem('lang', newLang);
                currentLang = newLang;
                // Reload content for the current page
                const pageId = document.body.dataset.pageId;
                loadContent(pageId);
            }
        }
        
        // üõë CRITICAL FIX: Initializes content loading AFTER the page is ready.
        document.addEventListener('DOMContentLoaded', () => {
            const pageId = document.body.dataset.pageId;
            loadContent(pageId);
        });

    </script>
</head>
<body data-page-id="chapter2">
    
    <div class="language-switcher">
        <button onclick="toggleTheme()">‚òÄÔ∏è / üåô</button>
        <button class="lang-btn" data-lang="en" onclick="switchLanguage('en')">EN</button>
        <button class="lang-btn" data-lang="de" onclick="switchLanguage('de')">DE</button>
    </div>

    <div class="story-container">
        
        <div id="chapter-nav-top"></div>

        <div class="story-block">
            
            <figure class="story-media" id="image-container">
                </figure>
            
            <div class="story-text" id="story-text-content">
                </div>
            
        </div>
    </div>

</body>
</html>