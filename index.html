<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="page-title">Loading...</title>
    <link rel="stylesheet" href="styles.css" />
    <script>
      // --- Theme Management (SHARED) ---
      document.addEventListener("DOMContentLoaded", () => {
        const currentTheme =
          localStorage.getItem("theme") ||
          (window.matchMedia("(prefers-color-scheme: dark)").matches
            ? "dark"
            : "light");
        document.body.setAttribute("data-theme", currentTheme);
      });

      function toggleTheme() {
        const currentTheme = document.body.getAttribute("data-theme");
        const newTheme = currentTheme === "light" ? "dark" : "light";
        document.body.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
      }

      // --- Content & Language Loading (INDEX SPECIFIC) ---
      let contentData = {};
      let currentLang = localStorage.getItem("lang") || "en";
      const PAGE_ID = "index"; // Fixed ID for this page

      async function loadIndexContent() {
        try {
          const response = await fetch("./content.json");
          contentData = await response.json();
          console.debug("Loaded content.json successfully");
        } catch (error) {
          console.error(
            "Could not fetch content.json (file:// or network issue), using inline fallback",
            error
          );
          // Fallback inline content for file:// protocol testing
          contentData = {
            site: {
              logo_url:
                "https://res.cloudinary.com/dqwm4pdbz/image/upload/v1764372864/imprintic_logo_gmmf4a.png",
            },
            en: {
              index: {
                title: "A Beautiful Mind",
                intro:
                  "This the is silent, profound and touching struggle of a beautiful soul navigating a world that wasn't built for her. A reality defined by immense love, exhaustion, and the unwavering struggle to secure a path forward for Maya.",
                subheadline: "Imagine",
                body_text:
                  "This story is an invitation to step quietly into a world that few outside our immediate family ever truly see: the relentless, often beautiful, and sometimes terrifying reality of parenting a child with severe autism. Our daughter is a beautiful soul. She is defined by an immense capacity for love, unexpected moments of radiant joy, and a spirit that continues to fight for connection. Yet, her life is also framed by struggles that demand constant, exhausting attentionâ€”struggles with communication, with sensory overload, and with behaviors that place her and us in perpetual crisis.",
                page_url: "index.html",
                next_story_link: "chapter1.html",
                media: {
                  url: "https://res.cloudinary.com/dqwm4pdbz/video/upload/v1764369265/SoH-Intro_seglsu.webm",
                  type: "video",
                  size_percentage: 50,
                  caption: "A Beautiful Mind",
                  use_soft_bg: false,
                },
                chapters: [
                  {
                    id: "chapter1",
                    title: "A Day in Our Life",
                    description: "Read about our initial concept and goals.",
                  },
                  {
                    id: "chapter2",
                    title: "Chapter 2: Data & Impact",
                    description: "View the supporting metrics and evidence.",
                  },
                ],
              },
            },
          };
        }
        injectIndexContent(currentLang);
      }

      function injectIndexContent(lang) {
        const langData = contentData[lang];
        if (!langData) return;

        const pageData = langData[PAGE_ID];
        if (!pageData) return;

        // Overlay helper moved to shared script: assets/js/video-overlay.js

        console.debug("injectIndexContent pageData:", pageData);
        console.debug("media field:", pageData.media);
        console.debug("image field:", pageData.image);

        // 1. Set Page Title (Browser tab title) and Visible Main Headline
        const pageTitleElement = document.getElementById("page-title");
        if (pageTitleElement) pageTitleElement.textContent = pageData.title;

        const mainTitleElement = document.getElementById("main-title");
        if (mainTitleElement) mainTitleElement.textContent = pageData.title;

        // 2. Inject Language Buttons (If any are needed in the future)
        document.querySelectorAll(".lang-btn").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.lang === lang);
        });

        // ðŸ›‘ NEW: Inject Sequential Navigation Links (Index only needs 'Next')
        const navTop = document.getElementById("chapter-nav-top");
        if (navTop) {
          let navHTML = "";

          // Index has no previous link, so we use a placeholder for alignment
          navHTML += `<span class="nav-placeholder"></span> | `;

          // Home Link (This is the Home page)
          navHTML += `<a href="${pageData.page_url}" class="nav-home">â˜°</a> | `;

          // Next Link
          if (pageData.next_story_link) {
            navHTML += `<a href="${pageData.next_story_link}" class="nav-next">Next â†£</a>`;
          } else {
            navHTML += `<span class="nav-placeholder"></span>`;
          }

          navTop.innerHTML = navHTML;
        }
        // ----------------------------------------------------

        // 3. Inject Media (Image or Video), Caption, and Set Size
        const imgContainer = document.getElementById("image-container");
        const mediaData = pageData.media || pageData.image; // fallback to image field for backwards compatibility

        console.debug("imgContainer found:", !!imgContainer);
        console.debug("mediaData:", mediaData);

        if (imgContainer && mediaData) {
          // Conditional soft background logic
          if (mediaData.use_soft_bg) {
            imgContainer.classList.add("soft-background-image");
          } else {
            imgContainer.classList.remove("soft-background-image");
          }

          let mediaHTML = "";
          const mediaType = mediaData.type || "image"; // default to image if type not specified

          if (mediaType === "video") {
            mediaHTML = `
                <video autoplay playsinline muted loop preload="metadata" style="width: 100%; height: auto; display: block; border-radius: 8px; max-width: 100%;">
                  <source src="${mediaData.url}" type="video/webm">
                  <source src="${mediaData.url.replace(
                    /\.webm$/i,
                    ".mp4"
                  )}" type="video/mp4">
                  Your browser does not support the video tag.
                </video>
                <figcaption>${mediaData.caption}</figcaption>
              `;
          } else {
            // Image rendering
            const webpUrl = mediaData.url.replace(/\.(jpe?g|png)$/i, ".webp");

            mediaHTML = `
                    <picture>
                        <source srcset="${webpUrl}" type="image/webp">
                        <img
                            src="${mediaData.url}"
                            alt="${mediaData.caption}"
                            style="width: 100%;"
                        >
                    </picture>
                    <figcaption>${mediaData.caption}</figcaption>
                `;
          }

          imgContainer.innerHTML = mediaHTML;

          // Set the media's width relative to the text using flex-basis
          imgContainer.style.flexBasis = mediaData.size_percentage + "%";

          // Force video autoplay on mobile (browsers block autoplay until user interaction)
          if (mediaType === "video") {
            const video = imgContainer.querySelector("video");
            if (video) {
              video.play().catch((err) => {
                console.debug("Video autoplay blocked:", err);
                // Try animated image fallback first (WebP -> GIF). If that fails, show overlay.
                if (window.attemptAnimatedImageFallback) {
                  const mediaUrl = mediaData && mediaData.url;
                  const animatedWebpUrl =
                    mediaData && mediaData.animated_webp_url;
                  window
                    .attemptAnimatedImageFallback(
                      imgContainer,
                      video,
                      mediaUrl,
                      mediaData && mediaData.caption,
                      animatedWebpUrl
                    )
                    .then((replaced) => {
                      if (!replaced) {
                        console.debug("Animated fallback not available");
                      } else {
                        console.debug("Animated fallback loaded successfully");
                      }
                    })
                    .catch(() => {
                      console.debug("Animated fallback attempt failed");
                    });
                } else {
                  console.debug("No animated fallback URL provided");
                }
              });
            }
          }

          console.debug(
            "Media rendered successfully. Type:",
            mediaType,
            "HTML:",
            mediaHTML
          );
        } else if (imgContainer) {
          imgContainer.style.display = "none";
          console.warn("No media data found for page");
        }

        // 4. Inject Intro Text
        const introElement = document.getElementById("story-intro");
        if (introElement) introElement.innerHTML = `<p>${pageData.intro}</p>`;

        // ðŸ›‘ NEW: Inject Subheadline ðŸ›‘
        const subheadlineElement = document.getElementById("index-subheadline");
        if (subheadlineElement)
          subheadlineElement.textContent = pageData.subheadline;

        // ðŸ›‘ NEW: Inject Body Text ðŸ›‘
        // Using innerHTML with <p> tags allows you to use HTML formatting (like <strong>) in content.json
        const bodyTextElement = document.getElementById("index-body-text");
        if (bodyTextElement)
          bodyTextElement.innerHTML = `<p>${pageData.body_text}</p>`;

        // 5. Inject Chapter Navigation List
        const navList = document.getElementById("chapters-list");
        if (navList) {
          navList.innerHTML = pageData.chapters
            .map((chapter) => {
              // Fallback to English data if the current language chapter data is missing
              const chapterData =
                langData[chapter.id] || contentData["en"][chapter.id];

              return `
                        <li>
                            <a href="${chapterData.page_url}">
                                <h2>${chapter.title}</h2>
                                <p>${chapter.description}</p>
                            </a>
                        </li>
                    `;
            })
            .join("");
        }
      }

      // Set footer logo from central site config (if present)
      try {
        const siteLogo =
          contentData && contentData.site && contentData.site.logo_url;
        const footerImg = document.getElementById("footer-logo-img");
        const fallbackLogo =
          "https://res.cloudinary.com/dqwm4pdbz/image/upload/v1764372864/imprintic_logo_gmmf4a.png";
        console.debug(
          "injectIndexContent: siteLogo=",
          siteLogo,
          "pageData.title=",
          pageData && pageData.title
        );
        if (footerImg) {
          footerImg.src = siteLogo || fallbackLogo;
          footerImg.alt =
            pageData && pageData.title ? pageData.title : "Site logo";
          footerImg.loading = "lazy";
          footerImg.onerror = function () {
            this.style.display = "none";
          };
        }
      } catch (e) {
        console.warn("Footer logo injection failed", e);
      }

      function switchLanguage(newLang) {
        if (contentData[newLang]) {
          localStorage.setItem("lang", newLang);
          currentLang = newLang;
          // Reload content for the index page
          injectIndexContent(newLang);
        }
      }

      // Initialization: Start content loading
      document.addEventListener("DOMContentLoaded", loadIndexContent);
    </script>
  </head>
  <body data-page-id="index" class="index-page">
    <div class="story-container">
      <div id="chapter-nav-top"></div>

      <div class="story-block">
        <figure class="story-media index-media" id="image-container"></figure>

        <div class="story-text" id="story-text-content">
          <h1 id="main-title"></h1>
          <div id="story-intro" class="story-intro"></div>
          <h2 id="index-subheadline" class="index-subheadline"></h2>
          <div id="index-body-text" class="index-body-text"></div>
          <nav class="campaign-nav">
            <ul id="chapters-list"></ul>
          </nav>
        </div>
      </div>
    </div>
    <footer class="site-footer" role="contentinfo">
      <div class="footer-inner">
        <div class="footer-center">
          <small>&copy; 2025 by</small>
          <a
            href="index.html"
            class="footer-logo"
            aria-label="Spectrum of Hope homepage"
          >
            <img
              id="footer-logo-img"
              src="https://res.cloudinary.com/dqwm4pdbz/image/upload/v1764520461/imprintic-emblem_olmzlh.png"
              class="logo-img"
              alt="Site logo"
              loading="lazy"
              onerror="this.style.display='none'"
            />
          </a>
        </div>
      </div>
    </footer>
    <script src="assets/js/video-overlay.js"></script>
  </body>
</html>
