<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="page-title">Loading...</title>
    <link rel="stylesheet" href="styles.css" />
    <script>
      // --- Theme Management (SHARED) ---
      document.addEventListener("DOMContentLoaded", () => {
        const currentTheme =
          localStorage.getItem("theme") ||
          (window.matchMedia("(prefers-color-scheme: dark)").matches
            ? "dark"
            : "light");
        document.body.setAttribute("data-theme", currentTheme);
      });

      function toggleTheme() {
        const currentTheme = document.body.getAttribute("data-theme");
        const newTheme = currentTheme === "light" ? "dark" : "light";
        document.body.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
      }

      // --- Content & Language Loading (INDEX SPECIFIC) ---
      let contentData = {};
      let currentLang = localStorage.getItem("lang") || "en";
      const PAGE_ID = "index"; // Fixed ID for this page

      async function loadIndexContent() {
        try {
          const response = await fetch("./content.json");
          contentData = await response.json();
        } catch (error) {
          console.error(
            "Fatal Error: Could not fetch or parse content.json",
            error
          );
          document.getElementById("page-title").textContent =
            "Error Loading Content";
          return;
        }

        // Call the shared content injection function
        injectIndexContent(currentLang);
      }

      function injectIndexContent(lang) {
        const langData = contentData[lang];
        if (!langData) return;

        const pageData = langData[PAGE_ID];
        if (!pageData) return;

        // 1. Set Page Title (Browser tab title) and Visible Main Headline
        const pageTitleElement = document.getElementById("page-title");
        if (pageTitleElement) pageTitleElement.textContent = pageData.title;

        const mainTitleElement = document.getElementById("main-title");
        if (mainTitleElement) mainTitleElement.textContent = pageData.title;

        // 2. Inject Language Buttons (If any are needed in the future)
        document.querySelectorAll(".lang-btn").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.lang === lang);
        });

        // ðŸ›‘ NEW: Inject Sequential Navigation Links (Index only needs 'Next')
        const navTop = document.getElementById("chapter-nav-top");
        if (navTop) {
          let navHTML = "";

          // Index has no previous link, so we use a placeholder for alignment
          navHTML += `<span class="nav-placeholder"></span> | `;

          // Home Link (This is the Home page)
          navHTML += `<a href="${pageData.page_url}" class="nav-home">â˜°</a> | `;

          // Next Link
          if (pageData.next_story_link) {
            navHTML += `<a href="${pageData.next_story_link}" class="nav-next">Next â†’</a>`;
          } else {
            navHTML += `<span class="nav-placeholder"></span>`;
          }

          navTop.innerHTML = navHTML;
        }
        // ----------------------------------------------------

        // 3. Inject Media (Image or Video), Caption, and Set Size
        const imgContainer = document.getElementById("image-container");
        const mediaData = pageData.media || pageData.image; // fallback to image field for backwards compatibility

        if (imgContainer && mediaData) {
          // Conditional soft background logic
          if (mediaData.use_soft_bg) {
            imgContainer.classList.add("soft-background-image");
          } else {
            imgContainer.classList.remove("soft-background-image");
          }

          let mediaHTML = "";
          const mediaType = mediaData.type || "image"; // default to image if type not specified

          if (mediaType === "video") {
            mediaHTML = `
                    <video
                        width="100%"
                        controls
                        style="width: 100%; height: auto; display: block; border-radius: 8px;"
                        alt="${mediaData.caption}"
                    >
                        <source src="${mediaData.url}" type="video/webm">
                        Your browser does not support the video tag.
                    </video>
                    <figcaption>${mediaData.caption}</figcaption>
                `;
          } else {
            // Image rendering
            const webpUrl = mediaData.url.replace(/\.(jpe?g|png)$/i, ".webp");

            mediaHTML = `
                    <picture>
                        <source srcset="${webpUrl}" type="image/webp">
                        <img
                            src="${mediaData.url}"
                            alt="${mediaData.caption}"
                            style="width: 100%;"
                        >
                    </picture>
                    <figcaption>${mediaData.caption}</figcaption>
                `;
          }

          imgContainer.innerHTML = mediaHTML;

          // Set the media's width relative to the text using flex-basis
          imgContainer.style.flexBasis = mediaData.size_percentage + "%";
        } else if (imgContainer) {
          imgContainer.style.display = "none";
        }

        // 4. Inject Intro Text
        const introElement = document.getElementById("story-intro");
        if (introElement) introElement.innerHTML = `<p>${pageData.intro}</p>`;

        // ðŸ›‘ NEW: Inject Subheadline ðŸ›‘
        const subheadlineElement = document.getElementById("index-subheadline");
        if (subheadlineElement)
          subheadlineElement.textContent = pageData.subheadline;

        // ðŸ›‘ NEW: Inject Body Text ðŸ›‘
        // Using innerHTML with <p> tags allows you to use HTML formatting (like <strong>) in content.json
        const bodyTextElement = document.getElementById("index-body-text");
        if (bodyTextElement)
          bodyTextElement.innerHTML = `<p>${pageData.body_text}</p>`;

        // 5. Inject Chapter Navigation List
        const navList = document.getElementById("chapters-list");
        if (navList) {
          navList.innerHTML = pageData.chapters
            .map((chapter) => {
              // Fallback to English data if the current language chapter data is missing
              const chapterData =
                langData[chapter.id] || contentData["en"][chapter.id];

              return `
                        <li>
                            <a href="${chapterData.page_url}">
                                <h2>${chapter.title}</h2>
                                <p>${chapter.description}</p>
                            </a>
                        </li>
                    `;
            })
            .join("");
        }
      }

      // Set footer logo from central site config (if present)
      try {
        const siteLogo =
          contentData && contentData.site && contentData.site.logo_url;
        const footerImg = document.getElementById("footer-logo-img");
        const fallbackLogo =
          "https://res.cloudinary.com/dqwm4pdbz/image/upload/v1764372864/imprintic_logo_gmmf4a.png";
        console.debug(
          "injectIndexContent: siteLogo=",
          siteLogo,
          "pageData.title=",
          pageData && pageData.title
        );
        if (footerImg) {
          footerImg.src = siteLogo || fallbackLogo;
          footerImg.alt =
            pageData && pageData.title ? pageData.title : "Site logo";
          footerImg.loading = "lazy";
          footerImg.onerror = function () {
            this.style.display = "none";
          };
        }
      } catch (e) {
        console.warn("Footer logo injection failed", e);
      }

      function switchLanguage(newLang) {
        if (contentData[newLang]) {
          localStorage.setItem("lang", newLang);
          currentLang = newLang;
          // Reload content for the index page
          injectIndexContent(newLang);
        }
      }

      // Initialization: Start content loading
      document.addEventListener("DOMContentLoaded", loadIndexContent);
    </script>
  </head>
  <body data-page-id="index" class="index-page">
    <div class="story-container">
      <div id="chapter-nav-top"></div>

      <div class="story-block">
        <figure class="story-media index-media" id="image-container"></figure>

        <div class="story-text" id="story-text-content">
          <h1 id="main-title"></h1>
          <div id="story-intro" class="story-intro"></div>
          <h2 id="index-subheadline" class="index-subheadline"></h2>
          <div id="index-body-text" class="index-body-text"></div>
          <nav class="campaign-nav">
            <ul id="chapters-list"></ul>
          </nav>
        </div>
      </div>
    </div>
    <footer class="site-footer" role="contentinfo">
      <div class="footer-inner">
        <div class="footer-center">
          <small>&copy; 2025 by</small>
          <a
            href="index.html"
            class="footer-logo"
            aria-label="Spectrum of Hope homepage"
          >
            <img
              id="footer-logo-img"
              src="https://res.cloudinary.com/dqwm4pdbz/image/upload/v1764372864/imprintic_logo_gmmf4a.png"
              class="logo-img"
              alt="Site logo"
              loading="lazy"
              onerror="this.style.display='none'"
            />
          </a>
        </div>
      </div>
    </footer>
  </body>
</html>
