<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Loading Campaign Index...</title>
    <link rel="stylesheet" href="styles.css"> 
</head>
<body data-theme="light">
    
    <nav class="language-switcher" id="lang-switcher"></nav>

    <main class="story-container index-page">
        
        <section class="story-text"> 
            
            <figure class="index-media" id="image-container"></figure>
            <h1 id="main-headline">Loading...</h1>
            <p class="story-intro" id="intro-text">Loading...</p>
            
        </section>
        
        <nav class="campaign-nav">
            <ul id="chapter-list"> 
                </ul>
        </nav>
        
        <div class="call-to-action">
             <a href="#" target="_blank" class="paypal-button">Support Our Mission</a>
        </div>

    </main>

    <script>
        const body = document.body;
        let currentLang = 'en';

        // --- Function to get the current language from the URL ---
        function getLang() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('lang') || 'en'; 
        }

        // --- 1. Content Loading Function ---
        async function loadContent() {
            currentLang = getLang();

            try {
                const response = await fetch('content.json');
                const data = await response.json();
                const pageData = data[currentLang]['index'];
                const settings = data.settings;

                // 1. Update Main Text
                document.getElementById('page-title').textContent = pageData.title;
                document.getElementById('main-headline').textContent = pageData.title;
                document.getElementById('intro-text').textContent = pageData.intro;

                // 2. Build Chapter List
                const chapterList = document.getElementById('chapter-list');
                chapterList.innerHTML = ''; 
                
                pageData.chapters.forEach(chapter => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    
                    // Set the link target, maintaining the current language
                    a.href = `${chapter.id}.html?lang=${currentLang}`;
                    a.innerHTML = `
                        <h2>${chapter.title}</h2>
                        <p>${chapter.description}</p>
                    `;
                    li.appendChild(a);
                    chapterList.appendChild(li);
                });

                // 3. Inject Image (The image will always fill the 100% container width)
                const imgContainer = document.getElementById('image-container');
                const imgData = pageData.image;

                if (imgData) {
                    const webpUrl = imgData.url.replace(/\.(jpe?g|png)$/i, '.webp'); 
                    
                    const imgHTML = `
                        <picture>
                            <source srcset="${webpUrl}" type="image/webp">
                            <img src="${imgData.url}" alt="${imgData.caption}" style="width: 100%; height: auto; border-radius: 8px;">
                        </picture>
                        <figcaption>${imgData.caption}</figcaption>
                    `;
                    imgContainer.innerHTML = imgHTML;
                } else {
                    imgContainer.style.display = 'none';
                }

                // 4. Build Language Switcher
                const langSwitcher = document.getElementById('lang-switcher');
                langSwitcher.innerHTML = settings.supportedLanguages.map(lang => {
                    const newUrl = `${window.location.pathname}?lang=${lang}`;
                    return `<a href="${newUrl}" style="margin: 0 10px; font-weight: ${lang === currentLang ? 'bold' : 'normal'}">${lang.toUpperCase()}</a>`;
                }).join('');

            } catch (error) {
                console.error("Error loading index content:", error);
                document.getElementById('main-headline').textContent = "Error Loading Content. Check content.json.";
            }
        }
        
        // --- 2. Theme Logic ---
        function applySystemTheme() {
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            body.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
        }

        // --- 3. Run on Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadContent();
            applySystemTheme();
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applySystemTheme);
        });
    </script>
</body>
</html>